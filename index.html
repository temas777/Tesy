<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>–¢—Ä–µ–Ω–∞–∂—ë—Ä –æ—Å–æ–∑–Ω–∞–Ω–Ω–æ—Å—Ç–∏</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Arial', sans-serif;
      background: linear-gradient(135deg, #2c3e50 0%, #4a6572 100%);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 15px;
    }

    .screen {
      display: none;
      width: 100%;
      max-width: 380px;
      text-align: center;
    }

    .active {
      display: block;
    }

    .container {
      background: #1a1a1a;
      border-radius: 20px;
      padding: 20px;
      box-shadow: 0 20px 40px rgba(0,0,0,0.1);
      position: relative;
    }

    /* –≠–∫—Ä–∞–Ω –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è */
    #welcomeScreen .container {
      background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
      color: white;
    }

    .welcome-title {
      font-size: 24px;
      font-weight: bold;
      margin-bottom: 15px;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    }

    .welcome-text {
      font-size: 16px;
      line-height: 1.5;
      margin-bottom: 25px;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
    }

    /* –ò–≥—Ä–æ–≤–æ–π —ç–∫—Ä–∞–Ω */
    #gameScreen .container {
      padding: 15px;
    }

    .game-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      gap: 8px;
      flex-wrap: nowrap;
    }

    .timer {
      background: #333;
      color: white;
      padding: 8px 12px;
      border-radius: 20px;
      font-size: 14px;
      font-weight: bold;
      min-width: 65px;
      text-align: center;
      flex-shrink: 0;
    }

    .game-area {
      position: relative;
      width: 100%;
      height: 450px;
      border: 2px solid #444;
      border-radius: 10px;
      overflow: hidden;
      margin-bottom: 15px;
      background: #000000;
    }

    #silhouette {
      width: 100%;
      height: 100%;
      object-fit: contain;
    }

    /* –í–ò–ó–£–ê–õ –¢–û–ß–ö–ò */
    #dot {
      width: 25px;
      height: 25px;
      background: #ff4444;
      border-radius: 50%;
      position: absolute;
      transition: all 4s cubic-bezier(0.4, 0, 0.2, 1);
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 10;
      box-shadow: 0 0 20px currentColor;
      border: 2px solid rgba(255,255,255,0.8);
    }

    /* –í–û–õ–ù–´ –í–ù–ò–ú–ê–ù–ò–Ø */
    .wave {
      position: absolute;
      border: 2px solid rgba(255,255,255,0.3);
      border-radius: 50%;
      animation: waveExpand 3s ease-out;
      pointer-events: none;
    }

    .guidance {
      position: absolute;
      bottom: 10px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.8);
      color: white;
      padding: 10px 15px;
      border-radius: 20px;
      font-size: 12px;
      z-index: 20;
      max-width: 90%;
      text-align: center;
      backdrop-filter: blur(10px);
    }

    /* –≠–∫—Ä–∞–Ω –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è */
    #endScreen .container {
      background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
      color: white;
    }

    .end-title {
      font-size: 22px;
      font-weight: bold;
      margin-bottom: 15px;
    }

    .end-text {
      font-size: 14px;
      line-height: 1.5;
      margin-bottom: 25px;
    }

    /* –ö–Ω–æ–ø–∫–∏ */
    .btn {
      background: #333;
      color: white;
      border: none;
      padding: 10px 15px;
      font-size: 14px;
      border-radius: 20px;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 3px 10px rgba(0,0,0,0.2);
      font-weight: bold;
      white-space: nowrap;
      flex-shrink: 0;
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    }

    .btn:active {
      transform: translateY(-1px);
    }

    .btn-start {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 12px 25px;
      font-size: 16px;
    }

    .btn-restart {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 12px 25px;
      font-size: 16px;
    }

    .btn-sound {
      padding: 8px 10px;
      font-size: 14px;
      min-width: 45px;
      background: #333;
      color: white; 
    }

    .btn-end {
      padding: 8px 12px;
      font-size: 12px;
      min-width: 70px;
      background: #333;
      color: white;
    }

    .status {
      margin: 8px 0;
      padding: 6px 12px;
      border-radius: 15px;
      font-size: 12px;
      background: #2a4365;
      color: #90cdf4;
    }

    /* –ê–ù–ò–ú–ê–¶–ò–ò */
    @keyframes waveExpand {
      0% {
        transform: translate(-50%, -50%) scale(1);
        opacity: 0.8;
      }
      100% {
        transform: translate(-50%, -50%) scale(3);
        opacity: 0;
      }
    }

    @keyframes pulse {
      0% { transform: translate(-50%, -50%) scale(1); }
      50% { transform: translate(-50%, -50%) scale(1.3); }
      100% { transform: translate(-50%, -50%) scale(1); }
    }

    @keyframes breathe {
      0% { transform: translate(-50%, -50%) scale(1); opacity: 0.7; }
      50% { transform: translate(-50%, -50%) scale(1.4); opacity: 1; }
      100% { transform: translate(-50%, -50%) scale(1); opacity: 0.7; }
    }

    @keyframes glow {
      0% { box-shadow: 0 0 10px currentColor; }
      50% { box-shadow: 0 0 30px currentColor; }
      100% { box-shadow: 0 0 10px currentColor; }
    }

    /* –°–∫—Ä—ã–≤–∞–µ–º canvas */
    #maskCanvas {
      display: none;
    }
  </style>
</head>
<body>
  <!-- –≠–∫—Ä–∞–Ω –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è -->
  <div id="welcomeScreen" class="screen active">
    <div class="container">
      <div class="welcome-title">üéØ –¢—Ä–µ–Ω–∞–∂—ë—Ä –æ—Å–æ–∑–Ω–∞–Ω–Ω–æ—Å—Ç–∏</div>
      <div class="welcome-text">
        –≠—Ç–æ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ –¥–ª—è —Ä–∞–∑–≤–∏—Ç–∏—è –≤–Ω–∏–º–∞–Ω–∏—è –∏ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è —Ç–µ–ª–µ—Å–Ω—ã—Ö –æ—â—É—â–µ–Ω–∏–π. 
        –ù–∞–±–ª—é–¥–∞–π—Ç–µ –∑–∞ –¥–≤–∏–∂–µ–Ω–∏–µ–º —Ç–æ—á–∫–∏ –∏ –ø—Ä–∏—Å–ª—É—à–∏–≤–∞–π—Ç–µ—Å—å –∫ —Å–≤–æ–∏–º –æ—â—É—â–µ–Ω–∏—è–º.
      </div>
      <button class="btn btn-start" onclick="startGame()">üöÄ –ù–∞—á–∞—Ç—å –ø—Ä–∞–∫—Ç–∏–∫—É</button>
    </div>
  </div>

  <!-- –ò–≥—Ä–æ–≤–æ–π —ç–∫—Ä–∞–Ω -->
  <div id="gameScreen" class="screen">
    <div class="container">
      <div class="game-header">
        <div class="timer" id="timer">05:00</div>
        <button class="btn btn-sound" id="soundBtn" onclick="toggleMusic()">üîä</button>
        <button class="btn btn-end" onclick="endGame()">‚èπÔ∏è –ó–∞–≤–µ—Ä—à–∏—Ç—å</button>
      </div>
      <div class="status" id="status">–°–ª–µ–¥–∏—Ç–µ –∑–∞ —Ç–æ—á–∫–æ–π...</div>
      <div class="game-area">
        <img id="silhouette" src="person.png" alt="–°–∏–ª—É—ç—Ç —á–µ–ª–æ–≤–µ–∫–∞">
        <div id="dot"></div>
        <div id="guidance"></div>
      </div>
    </div>
  </div>

  <!-- –≠–∫—Ä–∞–Ω –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è -->
  <div id="endScreen" class="screen">
    <div class="container">
      <div class="end-title">üôè –ë–ª–∞–≥–æ–¥–∞—Ä—é –∑–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</div>
      <div class="end-text">
        –í—ã —É–¥–µ–ª–∏–ª–∏ –≤—Ä–µ–º—è —Å–µ–±–µ –∏ —Å–≤–æ–µ–π –æ—Å–æ–∑–Ω–∞–Ω–Ω–æ—Å—Ç–∏. 
        –í–æ–∑–≤—Ä–∞—â–∞–π—Ç–µ—Å—å –¥–ª—è —Ä–µ–≥—É–ª—è—Ä–Ω–æ–π –ø—Ä–∞–∫—Ç–∏–∫–∏!
      </div>
      <button class="btn btn-restart" onclick="restartGame()">üîÑ –ü—Ä–∞–∫—Ç–∏–∫–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞</button>
    </div>
  </div>

  <!-- –ê—É–¥–∏–æ —ç–ª–µ–º–µ–Ω—Ç -->
  <audio id="backgroundMusic" loop>
    <source src="med.mp3" type="audio/mpeg">
  </audio>

  <!-- Canvas –¥–ª—è –≤—ã—á–∏—Å–ª–µ–Ω–∏–π (—Å–∫—Ä—ã—Ç) -->
  <canvas id="maskCanvas"></canvas>

  <script>
    // –≠–ª–µ–º–µ–Ω—Ç—ã
    const welcomeScreen = document.getElementById('welcomeScreen');
    const gameScreen = document.getElementById('gameScreen');
    const endScreen = document.getElementById('endScreen');
    const dot = document.getElementById('dot');
    const silhouette = document.getElementById('silhouette');
    const maskCanvas = document.getElementById('maskCanvas');
    const status = document.getElementById('status');
    const timerElement = document.getElementById('timer');
    const soundBtn = document.getElementById('soundBtn');
    const backgroundMusic = document.getElementById('backgroundMusic');
    const guidanceElement = document.getElementById('guidance');
    const ctx = maskCanvas.getContext('2d');

    // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∏–≥—Ä—ã
    let isMoving = false;
    let maskData = null;
    let gameTimer;
    let timeLeft = 300;
    let isMusicPlaying = false;

    // –ù–∞—Å—Ç—Ä–æ–π–∫–∏
    const MIN_STOP_TIME = 12000;
    const MAX_STOP_TIME = 15000;
    const GAME_DURATION = 300;

    // –¶–í–ï–¢–ê –î–õ–Ø –†–ê–ó–ù–´–• –ó–û–ù –¢–ï–õ–ê
    const ZONE_COLORS = {
      '–Ω–æ–≥–∏': '#4ECDC4',     // –±–∏—Ä—é–∑–æ–≤—ã–π
      '—Ç–∞–∑': '#FF6B6B',      // –∫—Ä–∞—Å–Ω—ã–π
      '–∂–∏–≤–æ—Ç': '#FFD166',    // –∂–µ–ª—Ç—ã–π
      '–≥—Ä—É–¥—å': '#06D6A0',    // –∑–µ–ª–µ–Ω—ã–π
      '–≥–æ—Ä–ª–æ': '#118AB2',    // —Å–∏–Ω–∏–π
      '–ª–æ–±': '#9D4EDD',      // —Ñ–∏–æ–ª–µ—Ç–æ–≤—ã–π
      '–º–∞–∫—É—à–∫–∞': '#FFFFFF'   // –±–µ–ª—ã–π
    };

    // –ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
    silhouette.onload = function() {
      maskCanvas.width = silhouette.naturalWidth || silhouette.width;
      maskCanvas.height = silhouette.naturalHeight || silhouette.height;
      createMask();
    };

    silhouette.onerror = function() {
      status.textContent = '‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è';
    };

    // –û–ü–†–ï–î–ï–õ–ï–ù–ò–ï –ó–û–ù–´ –¢–ï–õ–ê
    function detectBodyZone(x, y) {
      const percentY = parseFloat(y);
      
      if (percentY >= 80) return '–Ω–æ–≥–∏';
      if (percentY >= 65) return '—Ç–∞–∑';
      if (percentY >= 50) return '–∂–∏–≤–æ—Ç';
      if (percentY >= 35) return '–≥—Ä—É–¥—å';
      if (percentY >= 25) return '–≥–æ—Ä–ª–æ';
      if (percentY >= 15) return '–ª–æ–±';
      return '–º–∞–∫—É—à–∫–∞';
    }

    // –í–û–õ–ù–´ –í–ù–ò–ú–ê–ù–ò–Ø
    function createAttentionWave() {
      const wave = document.createElement('div');
      wave.className = 'wave';
      wave.style.left = dot.style.left;
      wave.style.top = dot.style.top;
      wave.style.borderColor = dot.style.backgroundColor;
      
      document.querySelector('.game-area').appendChild(wave);
      
      setTimeout(() => {
        wave.remove();
      }, 3000);
    }

    // –ò–ó–ú–ï–ù–ï–ù–ò–ï –í–ò–ó–£–ê–õ–ê –¢–û–ß–ö–ò
    function changeDotAppearance(zone) {
      const color = ZONE_COLORS[zone];
      
      // –¶–≤–µ—Ç —Ç–æ—á–∫–∏
      dot.style.background = color;
      dot.style.boxShadow = `0 0 25px ${color}80`;
      
      // –†–∞–∑–º–µ—Ä –∏ –∞–Ω–∏–º–∞—Ü–∏—è –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –∑–æ–Ω—ã
      const sizes = {
        '–Ω–æ–≥–∏': 20, '—Ç–∞–∑': 25, '–∂–∏–≤–æ—Ç': 22, 
        '–≥—Ä—É–¥—å': 28, '–≥–æ—Ä–ª–æ': 20, '–ª–æ–±': 18, '–º–∞–∫—É—à–∫–∞': 15
      };
      
      const animations = {
        '–Ω–æ–≥–∏': 'pulse 3s infinite',
        '—Ç–∞–∑': 'breathe 4s infinite',
        '–∂–∏–≤–æ—Ç': 'glow 2s infinite',
        '–≥—Ä—É–¥—å': 'pulse 2s infinite',
        '–≥–æ—Ä–ª–æ': 'breathe 3s infinite', 
        '–ª–æ–±': 'glow 3s infinite',
        '–º–∞–∫—É—à–∫–∞': 'pulse 5s infinite'
      };
      
      dot.style.width = sizes[zone] + 'px';
      dot.style.height = sizes[zone] + 'px';
      dot.style.animation = animations[zone];
    }

    // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –º—É–∑—ã–∫–∏
    function startMusic() {
      if (backgroundMusic) {
        backgroundMusic.volume = 0.1;
        backgroundMusic.play().then(() => {
          isMusicPlaying = true;
          soundBtn.textContent = 'üîä';
        }).catch(error => {
          console.log('–ê–≤—Ç–æ–∑–∞–ø—É—Å–∫ –º—É–∑—ã–∫–∏ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω:', error);
          soundBtn.textContent = 'üîá';
        });
      }
    }

    function stopMusic() {
      if (backgroundMusic && isMusicPlaying) {
        backgroundMusic.pause();
        backgroundMusic.currentTime = 0;
        isMusicPlaying = false;
        soundBtn.textContent = 'üîá';
      }
    }

    function toggleMusic() {
      if (isMusicPlaying) {
        backgroundMusic.pause();
        isMusicPlaying = false;
        soundBtn.textContent = 'üîá';
      } else {
        backgroundMusic.play().then(() => {
          isMusicPlaying = true;
          soundBtn.textContent = 'üîä';
        });
      }
    }

    function createMask() {
      ctx.clearRect(0, 0, maskCanvas.width, maskCanvas.height);
      ctx.drawImage(silhouette, 0, 0, maskCanvas.width, maskCanvas.height);
      maskData = ctx.getImageData(0, 0, maskCanvas.width, maskCanvas.height);
    }

    function isPointInSilhouette(x, y) {
      if (!maskData) return false;
      const pixelX = Math.floor(x);
      const pixelY = Math.floor(y);
      
      if (pixelX < 0 || pixelX >= maskCanvas.width || 
          pixelY < 0 || pixelY >= maskCanvas.height) {
        return false;
      }

      const index = (pixelY * maskCanvas.width + pixelX) * 4;
      const alpha = maskData.data[index + 3];
      return alpha > 50;
    }

    function findValidPosition(maxAttempts = 200) {
      let attempts = 0;
      
      while (attempts < maxAttempts) {
        const x = Math.random() * (maskCanvas.width - 20);
        const y = Math.random() * (maskCanvas.height - 20);
        
        let validPoints = 0;
        const checkPoints = [
          [x, y], [x+10, y], [x-10, y], [x, y+10], [x, y-10],
          [x+7, y+7], [x-7, y-7], [x+7, y-7], [x-7, y+7]
        ];
        
        checkPoints.forEach(point => {
          if (isPointInSilhouette(point[0], point[1])) {
            validPoints++;
          }
        });
        
        if (validPoints >= 6) {
          return { 
            x: (x / maskCanvas.width) * 100 + '%', 
            y: (y / maskCanvas.height) * 100 + '%' 
          };
        }
        attempts++;
      }
      return { x: '50%', y: '50%' };
    }

    function moveToRandomPosition() {
      const pos = findValidPosition();
      dot.style.left = pos.x;
      dot.style.top = pos.y;
      
      // –ê–ö–¢–ò–í–ê–¶–ò–Ø –í–ò–ó–£–ê–õ–¨–ù–´–• –≠–§–§–ï–ö–¢–û–í
      const zone = detectBodyZone(pos.x, pos.y);
      changeDotAppearance(zone);
      createAttentionWave();
      
      return true;
    }

    async function startMoving() {
      if (isMoving) return;
      isMoving = true;
      
      while (isMoving) {
        const success = moveToRandomPosition();
        if (!success) break;
        
        const stopTime = MIN_STOP_TIME + Math.random() * (MAX_STOP_TIME - MIN_STOP_TIME);
        await sleep(stopTime);
        
        if (!isMoving) break;
      }
    }

    function stopMoving() {
      isMoving = false;
    }

    // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–∞–π–º–µ—Ä–æ–º
    function updateTimer() {
      const minutes = Math.floor(timeLeft / 60);
      const seconds = timeLeft % 60;
      timerElement.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
      
      if (timeLeft <= 0) {
        endGame();
      } else {
        timeLeft--;
      }
    }

    // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —ç–∫—Ä–∞–Ω–∞–º–∏
    function startGame() {
      welcomeScreen.classList.remove('active');
      gameScreen.classList.add('active');
      endScreen.classList.remove('active');
      
      // –ó–∞–ø—É—Å–∫ –º—É–∑—ã–∫–∏
      startMusic();
      
      // –°–±—Ä–æ—Å —Ç–∞–π–º–µ—Ä–∞
      timeLeft = GAME_DURATION;
      updateTimer();
      gameTimer = setInterval(updateTimer, 1000);
      
      // –ó–∞–ø—É—Å–∫ –¥–≤–∏–∂–µ–Ω–∏—è —Ç–æ—á–∫–∏
      setTimeout(() => {
        moveToRandomPosition();
        startMoving();
      }, 1000);
    }

    function endGame() {
      gameScreen.classList.remove('active');
      endScreen.classList.add('active');
      
      // –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –º—É–∑—ã–∫–∏ –∏ –¥–≤–∏–∂–µ–Ω–∏—è
      stopMusic();
      clearInterval(gameTimer);
      stopMoving();
      
      // –°–±—Ä–æ—Å —Ç–æ—á–∫–∏
      dot.style.animation = 'none';
      dot.style.background = '#ff4444';
    }

    function restartGame() {
      endScreen.classList.remove('active');
      welcomeScreen.classList.add('active');
    }

    function sleep(ms) {
      return new Promise(resolve => setTimeout(resolve, ms));
    }

    // –ê–≤—Ç–æ-–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ—Ç–∏–≤ –∫–µ—à–∞
    if (window.location.search.indexOf('v=') === -1) {
      window.location.search = (window.location.search ? '&' : '?') + 'v=' + Date.now();
    }

    // Telegram Web App
    if (window.Telegram && Telegram.WebApp) {
      Telegram.WebApp.ready();
      Telegram.WebApp.expand();
    }
  </script>
</body>
</html>
